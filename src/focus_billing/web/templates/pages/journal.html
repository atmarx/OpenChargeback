{% extends "base.html" %}

{% block title %}Journal Export - OpenChargeback{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Journal Export</h1>
        <p class="page-subtitle">Export billing data for your financial system</p>
    </div>
</div>

<div class="card" style="max-width: 700px;">
    <div class="card-header">
        <h3 class="card-title">Export Options</h3>
    </div>
    <div class="card-body">
        <form method="post" action="/journal/export">
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="period_id" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Billing Period
                </label>
                <select id="period_id" name="period_id" class="form-input" style="width: 100%; max-width: 300px;" required onchange="updateStats()">
                    <option value="">Select Period</option>
                    {% for p in periods %}
                    <option value="{{ p.id }}" {% if current_period_id == p.id %}selected{% endif %}>
                        {{ p.period }} ({{ p.status }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            {% if stats %}
            <div class="card" style="background: var(--bg); margin-bottom: 20px;">
                <div class="card-body" style="padding: 15px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px;">Period Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div class="text-muted" style="font-size: 12px;">Total Cost</div>
                            <div class="font-mono" style="font-size: 16px; font-weight: 600;">
                                {{ stats.total_cost | currency }}
                            </div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: 12px;">Charges</div>
                            <div style="font-size: 16px; font-weight: 600;">
                                {{ stats.charge_count }}
                            </div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: 12px;">PIs</div>
                            <div style="font-size: 16px; font-weight: 600;">
                                {{ stats.pi_count }}
                            </div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: 12px;">Projects</div>
                            <div style="font-size: 16px; font-weight: 600;">
                                {{ stats.project_count }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                    Export Format
                </label>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="radio" name="format" value="standard" checked style="margin-top: 3px;">
                        <div>
                            <strong>Standard Detail</strong>
                            <p class="text-muted" style="margin: 2px 0 0 0; font-size: 13px;">
                                One row per charge with full details (PI, project, service, cost)
                            </p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="radio" name="format" value="summary" style="margin-top: 3px;">
                        <div>
                            <strong>Summary by PI/Project</strong>
                            <p class="text-muted" style="margin: 2px 0 0 0; font-size: 13px;">
                                Aggregated totals grouped by PI and project
                            </p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="radio" name="format" value="gl" style="margin-top: 3px;">
                        <div>
                            <strong>General Ledger</strong>
                            <p class="text-muted" style="margin: 2px 0 0 0; font-size: 13px;">
                                Debit/credit format grouped by fund/org for financial systems
                            </p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="radio" name="format" value="template" style="margin-top: 3px;">
                        <div>
                            <strong>Custom Template (GL)</strong>
                            <p class="text-muted" style="margin: 2px 0 0 0; font-size: 13px;">
                                Uses configured Jinja2 template with debit/credit entries per source
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="include_flagged" value="true">
                    <span>Include flagged charges (awaiting review)</span>
                </label>
                <p class="form-help" style="margin-left: 26px;">
                    By default, only approved charges are exported. Check this to include flagged charges.
                </p>
            </div>

            <div class="btn-group">
                <a href="/" class="btn btn-outline">Cancel</a>
                <button type="submit" class="btn btn-primary" {% if not current_period_id %}disabled{% endif %}>
                    <span>&#128202;</span> Download CSV
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Recent Exports -->
<div class="card" style="max-width: 700px; margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title">Recent Exports</h3>
    </div>
    <div class="card-body">
        {% if recent_exports %}
        <table>
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Format</th>
                    <th class="text-right">Rows</th>
                    <th class="text-right">Total</th>
                    <th>Exported</th>
                    <th>By</th>
                </tr>
            </thead>
            <tbody>
                {% for export in recent_exports %}
                <tr>
                    <td><a href="/periods/{{ export.period }}">{{ export.period }}</a></td>
                    <td>
                        {% if export.format == 'standard' %}
                        <span class="text-muted">Detail</span>
                        {% elif export.format == 'summary' %}
                        <span class="text-muted">Summary</span>
                        {% elif export.format == 'gl' %}
                        <span class="text-muted">GL</span>
                        {% elif export.format == 'template' %}
                        <span class="text-muted">Template</span>
                        {% else %}
                        <span class="text-muted">{{ export.format }}</span>
                        {% endif %}
                        {% if export.include_flagged %}
                        <span style="color: var(--warning);" title="Included flagged charges">*</span>
                        {% endif %}
                    </td>
                    <td class="text-right">{{ export.row_count }}</td>
                    <td class="text-right font-mono">{{ export.total_cost | currency }}</td>
                    <td class="text-muted">{{ export.exported_at[:10] if export.exported_at else 'N/A' }}</td>
                    <td class="text-muted">{{ export.exported_by or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-muted" style="text-align: center; padding: 20px;">
            No exports yet. Export a journal to see it logged here.
        </div>
        {% endif %}
    </div>
</div>

<div class="card" style="max-width: 700px; margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title">Export Formats Explained</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div>
                <h4 style="margin: 0 0 5px 0; font-size: 14px;">Standard Detail</h4>
                <p class="text-muted" style="margin: 0; font-size: 13px; line-height: 1.6;">
                    Complete line-item export with columns: period, pi_email, project_id, fund_org,
                    service_name, resource_id, resource_name, billed_cost, list_cost, discount_amount.
                    Best for detailed analysis and auditing.
                </p>
            </div>
            <div>
                <h4 style="margin: 0 0 5px 0; font-size: 14px;">Summary by PI/Project</h4>
                <p class="text-muted" style="margin: 0; font-size: 13px; line-height: 1.6;">
                    Aggregated view with columns: period, pi_email, project_id, fund_org, total_cost,
                    charge_count. Best for reporting and high-level analysis.
                </p>
            </div>
            <div>
                <h4 style="margin: 0 0 5px 0; font-size: 14px;">General Ledger</h4>
                <p class="text-muted" style="margin: 0; font-size: 13px; line-height: 1.6;">
                    Double-entry format with columns: period, account, description, debit, credit.
                    Each fund/org gets a debit entry, balanced by a credit to a clearing account.
                    Best for importing into financial/ERP systems.
                </p>
            </div>
            <div>
                <h4 style="margin: 0 0 5px 0; font-size: 14px;">Custom Template (GL)</h4>
                <p class="text-muted" style="margin: 0; font-size: 13px; line-height: 1.6;">
                    Uses a Jinja2 template (configured in config.yaml) to generate output.
                    Creates debit entries for each PI's fund/org and credit entries for each source's fund/org.
                    Fund/org strings are parsed via regex into components (fund, orgn, etc.).
                    Best for institution-specific GL formats.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
