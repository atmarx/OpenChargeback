{% extends "base.html" %}

{% block title %}Period {{ period.period }} - OpenChargeback{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ period.period }}</h1>
        <p class="page-subtitle">
            {% if period.status == 'open' %}
            <span class="status status-open"><span class="status-dot"></span>Open</span>
            {% elif period.status == 'closed' %}
            <span class="status status-closed"><span class="status-dot"></span>Closed</span>
            {% else %}
            <span class="status status-finalized"><span class="status-dot"></span>Finalized</span>
            {% endif %}
            &middot; Opened {{ period.opened_at[:10] if period.opened_at else 'N/A' }}
        </p>
    </div>
    <div class="btn-group">
        {% if period.status == 'open' %}
        <form method="post" action="/periods/{{ period.period }}/close" style="display: inline;">
            <button type="submit" class="btn btn-outline">Close Period</button>
        </form>
        <a href="/statements/generate?period={{ period.id }}" class="btn btn-primary">
            <span>&#9889;</span> Generate Statements
        </a>
        {% elif period.status == 'closed' %}
        <button type="button" class="btn btn-outline" onclick="document.getElementById('reopenModal').style.display='flex'">Reopen</button>
        <form method="post" action="/periods/{{ period.period }}/finalize" style="display: inline;">
            <button type="submit" class="btn btn-primary">Finalize</button>
        </form>
        {% else %}
        <a href="/statements?period={{ period.id }}" class="btn btn-outline">View Statements</a>
        {% endif %}
    </div>
</div>

{% if period.flagged_count > 0 %}
<div class="alert-banner">
    <span class="icon">&#9888;</span>
    <div class="message">
        <strong>{{ period.flagged_count }} charge{{ 's' if period.flagged_count != 1 else '' }} require{{ '' if period.flagged_count != 1 else 's' }} review</strong>
        Review and approve flagged charges before finalizing this period.
    </div>
    <a href="/review?period={{ period.id }}" class="btn btn-sm btn-outline">Review Now</a>
</div>
{% endif %}

<!-- Stats Grid -->
<div class="stats-grid">
    <a href="/charges?period={{ period.id }}" class="stat-card" style="text-decoration: none; color: inherit;">
        <div class="label">Total Charges</div>
        <div class="value">{{ period.total_cost | currency }}</div>
        <div class="change">{{ period.charge_count }} line items</div>
    </a>
    <a href="/projects?period={{ period.id }}" class="stat-card" style="text-decoration: none; color: inherit;">
        <div class="label">Active PIs</div>
        <div class="value">{{ period.pi_count }}</div>
        <div class="change">this period</div>
    </a>
    <a href="/projects?period={{ period.id }}" class="stat-card" style="text-decoration: none; color: inherit;">
        <div class="label">Projects</div>
        <div class="value">{{ period.project_count }}</div>
        <div class="change">across all PIs</div>
    </a>
    <a href="/review?period={{ period.id }}" class="stat-card" style="text-decoration: none; color: inherit;">
        <div class="label">Pending Review</div>
        <div class="value" {% if period.flagged_count > 0 %}style="color: var(--warning)"{% endif %}>
            {{ period.flagged_count }}
        </div>
        {% if period.flagged_count > 0 %}
        <div class="change negative">{{ period.flagged_cost | currency }} flagged</div>
        {% else %}
        <div class="change positive">All charges approved</div>
        {% endif %}
    </a>
</div>

<div class="grid-2">
    <!-- Imports for this period -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Imports</h3>
            {% if period.status == 'open' %}
            <a href="/imports/upload?period={{ period.id }}" class="btn btn-sm btn-outline">
                <span>&#8593;</span> Import CSV
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if imports %}
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Date</th>
                        <th class="text-right">Rows</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for import in imports %}
                    <tr>
                        <td><a href="/imports/{{ import.id }}">{{ import.filename }}</a></td>
                        <td class="text-muted">{{ import.imported_at[:10] if import.imported_at else 'N/A' }}</td>
                        <td class="text-right">{{ import.row_count }}</td>
                        <td class="text-right font-mono">{{ import.total_cost | currency }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state" style="padding: 30px;">
                <div class="icon">&#128196;</div>
                <h3>No imports yet</h3>
                <p>Import a FOCUS CSV file to add charges to this period.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top PIs by Spend -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Top PIs by Spend</h3>
            <a href="/charges?period={{ period.id }}" class="btn btn-sm btn-outline">View All Charges</a>
        </div>
        <div class="card-body">
            {% if top_pis %}
            <table>
                <thead>
                    <tr>
                        <th>PI</th>
                        <th>Projects</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pi in top_pis %}
                    <tr>
                        <td><a href="/projects?period={{ period.id }}&pi={{ pi.pi_email | urlencode }}">{{ pi.pi_email }}</a></td>
                        <td class="text-muted">{{ pi.project_count }} project{{ 's' if pi.project_count != 1 else '' }}</td>
                        <td class="text-right font-mono">{{ pi.total_cost | currency }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state" style="padding: 30px;">
                <div class="icon">&#128100;</div>
                <h3>No charges yet</h3>
                <p>Import billing data to see PI spending.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Statements for this period -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Statements</h3>
        {% if period.status != 'open' and statements %}
        <a href="/statements?period={{ period.id }}" class="btn btn-sm btn-outline">View All</a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if statements %}
        <table>
            <thead>
                <tr>
                    <th>PI</th>
                    <th>Projects</th>
                    <th class="text-right">Total</th>
                    <th>Generated</th>
                    <th>Sent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for stmt in statements[:10] %}
                <tr>
                    <td>{{ stmt.pi_email }}</td>
                    <td class="text-muted">{{ stmt.project_count }} project{{ 's' if stmt.project_count != 1 else '' }}</td>
                    <td class="text-right font-mono">{{ stmt.total_cost | currency }}</td>
                    <td class="text-muted">{{ stmt.generated_at[:10] if stmt.generated_at else 'N/A' }}</td>
                    <td>
                        {% if stmt.sent_at %}
                        <span class="status status-finalized"><span class="status-dot"></span>Sent</span>
                        {% else %}
                        <span class="text-muted">Not sent</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stmt.pdf_path %}
                        <a href="/statements/{{ stmt.id }}/download" class="btn btn-sm btn-outline">Download</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if statements | length > 10 %}
        <div style="text-align: center; padding-top: 15px;">
            <a href="/statements?period={{ period.id }}" class="btn btn-sm btn-outline">
                View All {{ statements | length }} Statements
            </a>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state" style="padding: 30px;">
            <div class="icon">&#128196;</div>
            <h3>No statements generated</h3>
            {% if period.status == 'open' %}
            <p>Close this period and generate statements when ready.</p>
            {% else %}
            <p>Generate statements for this billing period.</p>
            <a href="/statements/generate?period={{ period.id }}" class="btn btn-primary" style="margin-top: 15px;">
                Generate Statements
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if period.notes %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Notes</h3>
    </div>
    <div class="card-body">
        <p>{{ period.notes }}</p>
    </div>
</div>
{% endif %}

<!-- Audit Trail -->
{% if period.closed_by or period.finalized_by or period.reopened_by %}
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title">Audit Trail</h3>
    </div>
    <div class="card-body">
        <table>
            <tbody>
                {% if period.closed_at %}
                <tr>
                    <td style="width: 150px;" class="text-muted">Closed</td>
                    <td>{{ period.closed_at[:16] if period.closed_at else 'N/A' }}{% if period.closed_by %} by {{ period.closed_by }}{% endif %}</td>
                </tr>
                {% endif %}
                {% if period.finalized_at %}
                <tr>
                    <td class="text-muted">Finalized</td>
                    <td>{{ period.finalized_at[:16] if period.finalized_at else 'N/A' }}{% if period.finalized_by %} by {{ period.finalized_by }}{% endif %}</td>
                </tr>
                {% endif %}
                {% if period.reopened_at %}
                <tr>
                    <td class="text-muted">Reopened</td>
                    <td>{{ period.reopened_at[:16] if period.reopened_at else 'N/A' }}{% if period.reopened_by %} by {{ period.reopened_by }}{% endif %}</td>
                </tr>
                <tr>
                    <td class="text-muted">Reopen Reason</td>
                    <td>{{ period.reopen_reason or 'N/A' }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Reopen Modal -->
<div id="reopenModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; margin: 20px;">
        <div class="card-header">
            <h3 class="card-title">Reopen Period</h3>
        </div>
        <div class="card-body">
            <form method="post" action="/periods/{{ period.period }}/reopen">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="reason" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Reason for Reopening <span style="color: var(--danger);">*</span>
                    </label>
                    <textarea
                        id="reason"
                        name="reason"
                        class="form-input"
                        style="width: 100%; height: 100px;"
                        placeholder="Enter a reason for reopening this period..."
                        required
                    ></textarea>
                    <p class="form-help" style="margin-top: 5px; font-size: 12px; color: var(--text-muted);">
                        This will be recorded in the audit trail.
                    </p>
                </div>
                <div class="btn-group" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('reopenModal').style.display='none'">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Reopen Period
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
