{% extends "base.html" %}

{% block title %}Review Charges - OpenChargeback{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Review Charges</h1>
        <p class="page-subtitle">
            {{ total }} charge{{ 's' if total != 1 else '' }} need{{ 's' if total == 1 else '' }} review
            {% if current_period_name %}in {{ current_period_name }}{% endif %}
        </p>
    </div>
    {% if total > 0 and current_period_id %}
    <form method="post" action="/review/approve-all" style="display: inline;">
        <input type="hidden" name="period" value="{{ current_period_id }}">
        <button type="submit" class="btn btn-success" onclick="return confirm('Approve all {{ total }} flagged charges?')">
            Approve All ({{ total }})
        </button>
    </form>
    {% endif %}
</div>

{% if total > 0 %}
<div class="card">
    <div class="card-body">
        <!-- Filter Bar -->
        <form method="get" action="/review" class="filter-bar">
            <input
                type="text"
                name="search"
                class="search-input"
                placeholder="Search by PI, resource, or project..."
                value="{{ search }}"
            >
            <select name="period" class="filter-dropdown" onchange="this.form.submit()">
                <option value="">All Periods</option>
                {% for p in periods %}
                <option value="{{ p.id }}" {% if current_period_id == p.id %}selected{% endif %}>
                    {{ p.period }}
                </option>
                {% endfor %}
            </select>
            <select name="source" class="filter-dropdown" onchange="this.form.submit()">
                <option value="">All Sources</option>
                {% for s in sources %}
                <option value="{{ s.id }}" {% if current_source == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
            <select name="reason" class="filter-dropdown" onchange="this.form.submit()">
                <option value="">All Reasons</option>
                {% for r in reasons %}
                <option value="{{ r }}" {% if current_reason == r %}selected{% endif %}>
                    {{ r }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-outline btn-sm">Search</button>
            {% if search or current_source or current_reason %}
            <a href="/review{% if current_period_id %}?period={{ current_period_id }}{% endif %}" class="btn btn-outline btn-sm">Clear</a>
            {% endif %}
        </form>

        <form id="bulk-form" method="post" hx-boost="false" hx-disable>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all" onclick="toggleAll(this)">
                            </th>
                            <th>PI</th>
                            <th>Resource</th>
                            <th>Service</th>
                            <th>Reason</th>
                            <th class="text-right">Cost</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="review-table-body">
                        {% for charge in charges %}
                        <tr id="charge-row-{{ charge.id }}">
                            <td>
                                <input type="checkbox" name="charge_ids" value="{{ charge.id }}" class="charge-checkbox">
                            </td>
                            <td>{{ charge.pi_email }}</td>
                            <td>
                                <a href="/charges/{{ charge.id }}">
                                    <div>{{ charge.resource_id or 'N/A' }}</div>
                                    {% if charge.resource_name %}
                                    <div class="text-muted" style="font-size: 12px;">{{ charge.resource_name }}</div>
                                    {% endif %}
                                </a>
                            </td>
                            <td>{{ charge.service_name or 'N/A' }}</td>
                            <td>
                                <span class="status status-flagged">
                                    <span class="status-dot"></span>{{ charge.review_reason or 'Unknown' }}
                                </span>
                            </td>
                            <td class="text-right font-mono">{{ charge.billed_cost | currency }}</td>
                            <td>
                                <div class="btn-group">
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline"
                                        style="padding: 4px 8px;"
                                        hx-post="/review/{{ charge.id }}/approve"
                                        hx-target="#charge-row-{{ charge.id }}"
                                        hx-swap="outerHTML"
                                        title="Approve"
                                    >&#10003;</button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline"
                                        style="padding: 4px 8px;"
                                        hx-post="/review/{{ charge.id }}/reject"
                                        hx-target="#charge-row-{{ charge.id }}"
                                        hx-swap="outerHTML"
                                        hx-confirm="Reject and delete this charge?"
                                        title="Reject"
                                    >&#10005;</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="action-row">
                <span class="selected-count" id="selected-count">0 selected</span>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline btn-disabled" id="reject-selected-btn"
                        onclick="submitBulkAction('/review/reject-selected', 'Reject and delete selected charges?'); return false;">
                        Reject Selected
                    </button>
                    <button type="button" class="btn btn-sm btn-success btn-disabled" id="approve-selected-btn"
                        onclick="submitBulkAction('/review/approve-selected'); return false;">
                        Approve Selected
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="icon">&#10003;</div>
            <h3>All caught up!</h3>
            <p>No charges need review{% if current_period_name %} for {{ current_period_name }}{% endif %}.</p>
            <a href="/charges{% if current_period_id %}?period={{ current_period_id }}{% endif %}" class="btn btn-outline" style="margin-top: 15px;">View All Charges</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
