{% extends "base.html" %}

{% block title %}Charges - OpenChargeback{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Charges</h1>
        <p class="page-subtitle">
            {{ total }} charge{{ 's' if total != 1 else '' }}
            {% if current_period_name %}in {{ current_period_name }}{% endif %}
            {% if flagged %}(flagged only){% endif %}
        </p>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <!-- Filter Bar -->
        <form method="get" action="/charges" class="filter-bar">
            <input
                type="text"
                name="search"
                class="search-input"
                placeholder="Search by PI, resource, or project..."
                value="{{ search }}"
            >
            <select name="period" class="filter-dropdown" onchange="this.form.submit()">
                <option value="">All Periods</option>
                {% for p in periods %}
                <option value="{{ p.id }}" {% if current_period_id == p.id %}selected{% endif %}>
                    {{ p.period }} ({{ p.status }})
                </option>
                {% endfor %}
            </select>
            <select name="source" class="filter-dropdown" onchange="this.form.submit()">
                <option value="">All Sources</option>
                {% for s in sources %}
                <option value="{{ s.id }}" {% if current_source == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
                {% endfor %}
            </select>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" name="flagged" value="true" {% if flagged %}checked{% endif %} onchange="this.form.submit()">
                Flagged only
            </label>
            <button type="submit" class="btn btn-outline btn-sm">Search</button>
            {% if search or current_source or flagged %}
            <a href="/charges{% if current_period_id %}?period={{ current_period_id }}{% endif %}" class="btn btn-outline btn-sm">Clear</a>
            {% endif %}
        </form>

        {% if charges %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>PI</th>
                        <th>Resource</th>
                        <th>Service</th>
                        <th>Project</th>
                        <th class="text-right">Billed</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for charge in charges %}
                    <tr>
                        <td>
                            <a href="/charges?pi={{ charge.pi_email }}{% if current_period_id %}&period={{ current_period_id }}{% endif %}">
                                {{ charge.pi_email }}
                            </a>
                        </td>
                        <td>
                            <a href="/charges/{{ charge.id }}">
                                <div>{{ charge.resource_id or 'N/A' }}</div>
                                {% if charge.resource_name %}
                                <div class="text-muted" style="font-size: 12px;">{{ charge.resource_name }}</div>
                                {% endif %}
                            </a>
                        </td>
                        <td>{{ charge.service_name or 'N/A' }}</td>
                        <td>{{ charge.project_id or '-' }}</td>
                        <td class="text-right font-mono">{{ charge.billed_cost | currency }}</td>
                        <td>
                            {% if charge.needs_review %}
                            <span class="status status-flagged"><span class="status-dot"></span>Flagged</span>
                            {% else %}
                            <span class="status status-open"><span class="status-dot"></span>OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid var(--border); margin-top: 20px;">
            <span class="text-muted">
                Showing {{ (page - 1) * per_page + 1 }}-{{ [page * per_page, total] | min }} of {{ total }}
            </span>
            <div class="btn-group">
                {% if page > 1 %}
                <a href="/charges?page={{ page - 1 }}{% if current_period_id %}&period={{ current_period_id }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}{% if search %}&search={{ search }}{% endif %}{% if flagged %}&flagged=true{% endif %}" class="btn btn-sm btn-outline">
                    &larr; Previous
                </a>
                {% endif %}

                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <span class="btn btn-sm btn-primary">{{ p }}</span>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                    <a href="/charges?page={{ p }}{% if current_period_id %}&period={{ current_period_id }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}{% if search %}&search={{ search }}{% endif %}{% if flagged %}&flagged=true{% endif %}" class="btn btn-sm btn-outline">
                        {{ p }}
                    </a>
                    {% elif p == page - 3 or p == page + 3 %}
                    <span class="text-muted">&hellip;</span>
                    {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                <a href="/charges?page={{ page + 1 }}{% if current_period_id %}&period={{ current_period_id }}{% endif %}{% if current_source %}&source={{ current_source }}{% endif %}{% if search %}&search={{ search }}{% endif %}{% if flagged %}&flagged=true{% endif %}" class="btn btn-sm btn-outline">
                    Next &rarr;
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="empty-state">
            <div class="icon">&#9783;</div>
            <h3>No charges found</h3>
            {% if search or current_source or flagged %}
            <p>Try adjusting your filters or search terms.</p>
            <a href="/charges{% if current_period_id %}?period={{ current_period_id }}{% endif %}" class="btn btn-outline" style="margin-top: 15px;">Clear Filters</a>
            {% else %}
            <p>Import billing data to see charges here.</p>
            <a href="/imports/upload" class="btn btn-primary" style="margin-top: 15px;">Import Data</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
